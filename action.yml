name: 'Java Analyzer'
description: 'Fast static code analyzer for Java with 987 SonarSource-based rules'
author: 'andreisuslov'

branding:
  icon: 'check-circle'
  color: 'green'

inputs:
  path:
    description: 'Path to analyze (file or directory)'
    required: false
    default: '.'
  min-severity:
    description: 'Minimum severity level to report (info, minor, major, critical, blocker)'
    required: false
    default: 'info'
  fail-on-severity:
    description: 'Fail if issues of this severity or higher are found'
    required: false
    default: ''
  format:
    description: 'Output format (text, json, sarif, csv, markdown, gitlab)'
    required: false
    default: 'text'
  exclude-rules:
    description: 'Comma-separated list of rules to exclude'
    required: false
    default: ''
  exclude-patterns:
    description: 'Comma-separated list of path patterns to exclude'
    required: false
    default: ''
  max-complexity:
    description: 'Maximum cognitive complexity threshold'
    required: false
    default: '15'
  quality-gate:
    description: 'Quality gate preset (strict, standard, lenient) or path to custom quality gate file'
    required: false
    default: ''
  compliance:
    description: 'Compliance reporting mode (owasp, cwe) - groups issues by compliance standard'
    required: false
    default: ''
  sarif-upload:
    description: 'Upload SARIF results to GitHub Security tab (true/false)'
    required: false
    default: 'false'

outputs:
  issues-count:
    description: 'Total number of issues found'
    value: ${{ steps.analyze.outputs.issues-count }}
  blocker-count:
    description: 'Number of blocker issues'
    value: ${{ steps.analyze.outputs.blocker-count }}
  critical-count:
    description: 'Number of critical issues'
    value: ${{ steps.analyze.outputs.critical-count }}
  quality-gate-status:
    description: 'Quality gate status (passed/failed)'
    value: ${{ steps.analyze.outputs.quality-gate-status }}
  sarif-file:
    description: 'Path to generated SARIF file (if sarif-upload is enabled)'
    value: ${{ steps.analyze.outputs.sarif-file }}

runs:
  using: 'composite'
  steps:
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache java-analyzer
      uses: actions/cache@v4
      id: cache-analyzer
      with:
        path: ~/.cargo/bin/java-analyzer
        key: java-analyzer-${{ runner.os }}-v1.0.0

    - name: Install java-analyzer
      if: steps.cache-analyzer.outputs.cache-hit != 'true'
      shell: bash
      run: |
        cargo install --git https://github.com/andreisuslov/java-analyzer.git

    - name: Run analysis
      id: analyze
      shell: bash
      env:
        ANALYZER_PATH: ${{ inputs.path }}
        ANALYZER_SEVERITY: ${{ inputs.min-severity }}
        ANALYZER_FAIL_SEVERITY: ${{ inputs.fail-on-severity }}
        ANALYZER_FORMAT: ${{ inputs.format }}
        ANALYZER_EXCLUDE_RULES: ${{ inputs.exclude-rules }}
        ANALYZER_EXCLUDE_PATTERNS: ${{ inputs.exclude-patterns }}
        ANALYZER_MAX_COMPLEXITY: ${{ inputs.max-complexity }}
        ANALYZER_QUALITY_GATE: ${{ inputs.quality-gate }}
        ANALYZER_COMPLIANCE: ${{ inputs.compliance }}
        ANALYZER_SARIF_UPLOAD: ${{ inputs.sarif-upload }}
      run: |
        ARGS="--format $ANALYZER_FORMAT --min-severity $ANALYZER_SEVERITY --max-complexity $ANALYZER_MAX_COMPLEXITY"

        if [ -n "$ANALYZER_FAIL_SEVERITY" ]; then
          ARGS="$ARGS --fail-on-severity $ANALYZER_FAIL_SEVERITY"
        fi

        if [ -n "$ANALYZER_EXCLUDE_RULES" ]; then
          ARGS="$ARGS --exclude-rules $ANALYZER_EXCLUDE_RULES"
        fi

        if [ -n "$ANALYZER_EXCLUDE_PATTERNS" ]; then
          ARGS="$ARGS --exclude $ANALYZER_EXCLUDE_PATTERNS"
        fi

        # Add quality gate if specified
        if [ -n "$ANALYZER_QUALITY_GATE" ]; then
          # Check if it's a preset or a file path
          if [[ "$ANALYZER_QUALITY_GATE" =~ ^(strict|standard|lenient)$ ]]; then
            ARGS="$ARGS --quality-gate $ANALYZER_QUALITY_GATE"
          elif [ -f "$ANALYZER_QUALITY_GATE" ]; then
            ARGS="$ARGS --quality-gate-file $ANALYZER_QUALITY_GATE"
          else
            echo "Warning: Quality gate '$ANALYZER_QUALITY_GATE' is not a valid preset or file"
          fi
        fi

        # Add compliance mode if specified
        if [ -n "$ANALYZER_COMPLIANCE" ]; then
          ARGS="$ARGS --compliance $ANALYZER_COMPLIANCE"
        fi

        # Run analysis and capture output
        OUTPUT=$(~/.cargo/bin/java-analyzer "$ANALYZER_PATH" $ARGS --summary-only 2>&1) || true
        echo "$OUTPUT"

        # Extract counts from output
        ISSUES=$(echo "$OUTPUT" | grep -oP 'Total issues:\s*\K\d+' || echo "0")
        BLOCKER=$(echo "$OUTPUT" | grep -oP 'BLOCKER\s*:\s*\K\d+' || echo "0")
        CRITICAL=$(echo "$OUTPUT" | grep -oP 'CRITICAL\s*:\s*\K\d+' || echo "0")

        # Check for quality gate status
        if echo "$OUTPUT" | grep -q "Quality Gate.*PASSED"; then
          GATE_STATUS="passed"
        elif echo "$OUTPUT" | grep -q "Quality Gate.*FAILED"; then
          GATE_STATUS="failed"
        else
          GATE_STATUS="not-configured"
        fi

        echo "issues-count=$ISSUES" >> $GITHUB_OUTPUT
        echo "blocker-count=$BLOCKER" >> $GITHUB_OUTPUT
        echo "critical-count=$CRITICAL" >> $GITHUB_OUTPUT
        echo "quality-gate-status=$GATE_STATUS" >> $GITHUB_OUTPUT

        # Generate SARIF file if sarif-upload is enabled
        if [ "$ANALYZER_SARIF_UPLOAD" = "true" ]; then
          SARIF_FILE="java-analyzer-results.sarif"

          # Build args for SARIF generation (without compliance which affects grouping)
          SARIF_ARGS="--format sarif --min-severity $ANALYZER_SEVERITY --max-complexity $ANALYZER_MAX_COMPLEXITY"

          if [ -n "$ANALYZER_EXCLUDE_RULES" ]; then
            SARIF_ARGS="$SARIF_ARGS --exclude-rules $ANALYZER_EXCLUDE_RULES"
          fi

          if [ -n "$ANALYZER_EXCLUDE_PATTERNS" ]; then
            SARIF_ARGS="$SARIF_ARGS --exclude $ANALYZER_EXCLUDE_PATTERNS"
          fi

          ~/.cargo/bin/java-analyzer "$ANALYZER_PATH" $SARIF_ARGS --output "$SARIF_FILE"
          echo "sarif-file=$SARIF_FILE" >> $GITHUB_OUTPUT
          echo "Generated SARIF file: $SARIF_FILE"
        fi

        # Run full analysis with original format
        ~/.cargo/bin/java-analyzer "$ANALYZER_PATH" $ARGS

    - name: Upload SARIF to GitHub Security
      if: inputs.sarif-upload == 'true'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: java-analyzer-results.sarif
        category: java-analyzer
